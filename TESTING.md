# 🧪 AI 朋友圈功能测试指南

## 测试前准备

### 1. 确认服务已启动

```bash
# 检查后端服务（端口 3000）
lsof -ti:3000

# 检查前端服务（端口 8000）
lsof -ti:8000
```

如果没有输出，说明服务未启动，请先执行：
```bash
./start-services.sh
```

### 2. 确认 API 配置

检查 `backend/.env` 文件：
```env
DASHSCOPE_API_KEY=sk-dccc9e36e0504a70a9f468c215df0e27
DASHSCOPE_MODEL=qwen-max
```

---

## 测试场景 1：发布动态并等待 AI 互动

### 步骤

1. **打开主页面**
   ```
   http://localhost:8000/video_player.html
   ```

2. **打开 AI 朋友圈**
   - 点击视频播放器右下角的 **👥** 按钮
   - 侧边栏从右侧滑出

3. **发布动态**
   - 点击"✏️ 发布动态"按钮
   - 输入测试内容：
     ```
     今天看了《许我耀眼》第一集，赵露思的演技真的太棒了！
     ```
   - 点击"发布"按钮

4. **观察 AI 互动**
   - 等待 10-30 秒
   - 观察是否有 AI 角色（沈皓明、许妍、方蕾）点赞或评论
   - 页面每 5 秒自动刷新一次

5. **查看后端日志**
   ```bash
   tail -f backend.log
   ```
   应该看到类似输出：
   ```
   📝 新动态发布: 今天看了《许我耀眼》第一集...
   🤖 触发 AI 互动...
   ✅ AI 回复成功
   ```

### 预期结果

✅ **成功标志：**
- 动态成功发布并显示在列表中
- 10-30 秒内有 AI 点赞或评论
- 后端日志显示"✅ AI 回复成功"
- 页面自动刷新显示 AI 互动

❌ **失败情况：**
- 超过 30 秒没有 AI 互动
- 后端日志显示错误信息
- 页面没有自动刷新

---

## 测试场景 2：发表评论并等待 AI 回复

### 步骤

1. **找到任意动态**
   - 在 AI 朋友圈侧边栏中找到一条动态
   - 如果没有动态，先发布一条（参考场景 1）

2. **发表评论**
   - 在动态下方的输入框中输入：
     ```
     我也很喜欢这部剧！
     ```
   - 点击"发送"按钮

3. **观察 AI 回复**
   - 等待 3-8 秒
   - 观察是否有 AI 回复你的评论
   - 页面会自动刷新显示新评论

4. **查看后端日志**
   ```bash
   tail -f backend.log
   ```
   应该看到：
   ```
   💬 新评论: 我也很喜欢这部剧！
   🤖 AI 正在生成回复...
   ✅ AI 回复成功: [AI 的回复内容]
   ```

### 预期结果

✅ **成功标志：**
- 评论成功发表并显示
- 3-8 秒内有 AI 回复
- AI 回复内容自然、贴合上下文
- 后端日志显示 AI 处理过程

---

## 测试场景 3：点赞功能

### 步骤

1. **点赞动态**
   - 点击动态右上角的 **⋯** 按钮
   - 选择"点赞"

2. **验证点赞**
   - 动态下方应显示"❤️ 我"
   - 点赞数增加

3. **取消点赞**
   - 再次点击 **⋯** 按钮
   - 选择"取消赞"
   - 点赞信息消失

### 预期结果

✅ **成功标志：**
- 点赞立即生效
- 点赞列表正确显示
- 取消点赞正常工作

---

## 测试场景 4：删除功能

### 步骤

1. **删除自己的动态**
   - 找到自己发布的动态（用户名为"我"）
   - 点击右上角的 **🗑️** 按钮
   - 确认删除

2. **删除自己的评论**
   - 找到自己发表的评论
   - 点击评论下方的"删除"按钮
   - 确认删除

### 预期结果

✅ **成功标志：**
- 动态/评论立即从列表中消失
- 相关的点赞和评论也被删除
- 无法删除他人的动态/评论

---

## 测试场景 5：自动刷新功能

### 步骤

1. **打开两个浏览器窗口**
   - 窗口 A：http://localhost:8000/video_player.html
   - 窗口 B：http://localhost:8000/video_player.html

2. **在窗口 A 发布动态**
   - 发布一条测试动态

3. **观察窗口 B**
   - 等待最多 5 秒
   - 窗口 B 应自动显示新动态

### 预期结果

✅ **成功标志：**
- 窗口 B 在 5 秒内自动刷新
- 新动态在两个窗口中都显示
- 无需手动刷新页面

---

## 测试场景 6：多轮对话

### 步骤

1. **发布动态**
   ```
   今天天气真好！
   ```

2. **等待 AI 评论**
   - 等待 10-30 秒
   - AI 会发表评论，例如："确实是个好天气！"

3. **回复 AI 的评论**
   - 点击 AI 评论下方的"回复"按钮
   - 输入：
     ```
     是啊，适合出去玩！
     ```
   - 点击"发送"

4. **等待 AI 再次回复**
   - 等待 3-8 秒
   - AI 会回复你的回复

### 预期结果

✅ **成功标志：**
- AI 能理解上下文
- 回复内容连贯、自然
- 支持多轮对话

---

## 性能测试

### 测试 API 响应时间

```bash
# 测试获取动态列表
time curl http://localhost:3000/api/moments

# 测试发布动态
time curl -X POST http://localhost:3000/api/moments \
  -H "Content-Type: application/json" \
  -d '{"userId":"test","username":"测试","content":"测试内容"}'
```

### 预期性能

- 获取动态列表：< 100ms
- 发布动态：< 200ms
- AI 回复生成：3-8 秒
- 页面自动刷新：5 秒间隔

---

## 压力测试

### 快速发布多条动态

```bash
# 使用脚本快速发布 10 条动态
for i in {1..10}; do
  curl -X POST http://localhost:3000/api/moments \
    -H "Content-Type: application/json" \
    -d "{\"userId\":\"test\",\"username\":\"测试用户\",\"content\":\"测试动态 $i\"}"
  sleep 1
done
```

### 预期结果

✅ **成功标志：**
- 所有动态都成功发布
- 服务器不崩溃
- AI 能处理所有动态（可能需要更长时间）

---

## 故障排查

### 问题 1：AI 没有回复

**可能原因：**
1. API Key 错误或过期
2. 网络连接问题
3. API 配额用尽
4. 后端服务异常

**排查步骤：**
```bash
# 1. 检查后端日志
tail -f backend.log

# 2. 测试 API 连接
curl -X POST https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions \
  -H "Authorization: Bearer sk-dccc9e36e0504a70a9f468c215df0e27" \
  -H "Content-Type: application/json" \
  -d '{"model":"qwen-max","messages":[{"role":"user","content":"测试"}]}'

# 3. 重启后端服务
./stop-services.sh
./start-services.sh
```

### 问题 2：页面不刷新

**可能原因：**
1. JavaScript 错误
2. 自动刷新定时器未启动
3. API 请求失败

**排查步骤：**
```bash
# 1. 打开浏览器控制台（F12）
# 2. 查看 Console 标签是否有错误
# 3. 查看 Network 标签，确认 API 请求正常
# 4. 刷新页面重新加载
```

### 问题 3：评论无法发送

**可能原因：**
1. 输入框为空
2. 后端 API 异常
3. 网络请求失败

**排查步骤：**
```bash
# 1. 确认输入框有内容
# 2. 查看浏览器控制台错误
# 3. 测试 API 端点
curl -X POST http://localhost:3000/api/moments/1/comments \
  -H "Content-Type: application/json" \
  -d '{"userId":"test","username":"测试","content":"测试评论"}'
```

---

## 测试清单

使用以下清单确保所有功能正常：

- [ ] 服务启动成功（后端 + 前端）
- [ ] 打开 AI 朋友圈侧边栏
- [ ] 发布动态成功
- [ ] AI 在 10-30 秒内互动
- [ ] 发表评论成功
- [ ] AI 在 3-8 秒内回复
- [ ] 点赞功能正常
- [ ] 取消点赞正常
- [ ] 删除动态成功
- [ ] 删除评论成功
- [ ] 页面自动刷新（5 秒）
- [ ] 多轮对话正常
- [ ] 回复功能正常
- [ ] 后端日志正常
- [ ] 无 JavaScript 错误

---

## 测试报告模板

```
测试日期：2025-XX-XX
测试人员：XXX
测试环境：macOS / Windows / Linux

【测试结果】
✅ 发布动态：通过
✅ AI 互动：通过
✅ 评论功能：通过
✅ 点赞功能：通过
✅ 删除功能：通过
✅ 自动刷新：通过

【性能数据】
- API 响应时间：XX ms
- AI 回复时间：X-X 秒
- 页面刷新间隔：5 秒

【问题记录】
1. 无

【建议】
1. 功能正常，可以投入使用
```

---

## 下一步

测试通过后，可以：
1. 📖 查看完整文档：[README.md](README.md)
2. 🎬 上传视频开始使用
3. 🎨 自定义 AI 角色和回复模板
4. 🚀 部署到生产环境

---

**提示**：建议每次修改代码后都运行完整的测试流程，确保功能正常。
