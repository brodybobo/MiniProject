<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æœ‹å‹åœˆæ¥å£æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .test-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }

        .panel-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6c757d;
        }

        .status-indicator.online {
            background: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        }

        .status-indicator.error {
            background: #dc3545;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .log-panel {
            grid-column: 1 / -1;
            background: #1e1e1e;
            color: #f8f8f2;
            border-radius: 12px;
            padding: 25px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 4px solid transparent;
        }

        .log-entry.info {
            background: rgba(79, 172, 254, 0.1);
            border-left-color: #4facfe;
        }

        .log-entry.success {
            background: rgba(40, 167, 69, 0.1);
            border-left-color: #28a745;
        }

        .log-entry.error {
            background: rgba(220, 53, 69, 0.1);
            border-left-color: #dc3545;
        }

        .log-entry.warning {
            background: rgba(255, 193, 7, 0.1);
            border-left-color: #ffc107;
        }

        .timestamp {
            color: #6c757d;
            font-size: 0.85em;
        }

        .moments-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }

        .moment-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .moment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .moment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .moment-content {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .moment-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .comment-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .comments-list {
            margin-top: 10px;
            padding-left: 20px;
        }

        .comment-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .ai-comment {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AI æœ‹å‹åœˆæ¥å£æµ‹è¯•å·¥å…·</h1>
            <p>æµ‹è¯•åç«¯å¤§æ¨¡å‹æ¥å£çš„æœ‹å‹åœˆè¯„è®ºå›å¤åŠŸèƒ½</p>
        </div>

        <div class="main-content">
            <!-- æœåŠ¡å™¨çŠ¶æ€é¢æ¿ -->
            <div class="test-panel">
                <div class="panel-title">
                    <span class="status-indicator" id="serverStatus"></span>
                    æœåŠ¡å™¨çŠ¶æ€
                </div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalMoments">0</div>
                        <div class="stat-label">åŠ¨æ€æ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="aiReplies">0</div>
                        <div class="stat-label">AI å›å¤æ•°</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>æœåŠ¡å™¨åœ°å€</label>
                    <input type="text" class="form-control" id="serverUrl" value="http://localhost:3000">
                </div>

                <button class="btn btn-primary" onclick="checkServerStatus()">
                    <span id="checkStatusIcon">ğŸ”</span>
                    æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
                </button>
            </div>

            <!-- å‘å¸ƒåŠ¨æ€é¢æ¿ -->
            <div class="test-panel">
                <div class="panel-title">
                    ğŸ“ å‘å¸ƒæµ‹è¯•åŠ¨æ€
                </div>

                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" class="form-control" id="username" value="æµ‹è¯•ç”¨æˆ·">
                </div>

                <div class="form-group">
                    <label>åŠ¨æ€å†…å®¹</label>
                    <textarea class="form-control" id="momentContent" placeholder="è¾“å…¥åŠ¨æ€å†…å®¹...">ä»Šå¤©çœ‹äº†ã€Šè®¸æˆ‘è€€çœ¼ã€‹è¿™éƒ¨å‰§ï¼ŒçœŸçš„å¤ªå¥½çœ‹äº†ï¼æ¼”å‘˜ä»¬çš„æ¼”æŠ€éƒ½å¾ˆæ£’ï¼</textarea>
                </div>

                <button class="btn btn-success" onclick="publishMoment()" id="publishBtn">
                    <span>ğŸ“¤</span>
                    å‘å¸ƒåŠ¨æ€
                </button>
            </div>

            <!-- åŠ¨æ€åˆ—è¡¨é¢æ¿ -->
            <div class="test-panel">
                <div class="panel-title">
                    ğŸ“‹ åŠ¨æ€åˆ—è¡¨
                </div>

                <button class="btn btn-primary" onclick="refreshMoments()" style="margin-bottom: 15px;">
                    <span>ğŸ”„</span>
                    åˆ·æ–°åŠ¨æ€
                </button>

                <div class="moments-list" id="momentsList">
                    <div style="text-align: center; color: #6c757d; padding: 20px;">
                        æš‚æ— åŠ¨æ€ï¼Œè¯·å…ˆå‘å¸ƒä¸€æ¡åŠ¨æ€
                    </div>
                </div>
            </div>

            <!-- AI æµ‹è¯•é¢æ¿ -->
            <div class="test-panel">
                <div class="panel-title">
                    ğŸ¤– AI å›å¤æµ‹è¯•
                </div>

                <div class="form-group">
                    <label>é€‰æ‹©åŠ¨æ€IDè¿›è¡Œè¯„è®ºæµ‹è¯•</label>
                    <select class="form-control" id="momentSelect">
                        <option value="">è¯·å…ˆå‘å¸ƒåŠ¨æ€</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æµ‹è¯•è¯„è®ºå†…å®¹</label>
                    <textarea class="form-control" id="testComment" placeholder="è¾“å…¥æµ‹è¯•è¯„è®º...">è¿™éƒ¨å‰§çœŸçš„å¾ˆä¸é”™å‘¢ï¼</textarea>
                </div>

                <button class="btn btn-warning" onclick="testAIReply()" id="testAIBtn">
                    <span>ğŸ¯</span>
                    æµ‹è¯• AI å›å¤
                </button>

                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="clearLogs()">
                        <span>ğŸ—‘ï¸</span>
                        æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—é¢æ¿ -->
        <div class="log-panel">
            <div class="panel-title" style="color: #f8f8f2; margin-bottom: 15px;">
                ğŸ“Š API è°ƒç”¨æ—¥å¿—
            </div>
            <div id="logContainer">
                <div class="log-entry info">
                    <span class="timestamp">[å¯åŠ¨]</span> AI æœ‹å‹åœˆæ¥å£æµ‹è¯•å·¥å…·å·²åŠ è½½
                </div>
            </div>
        </div>
    </div>

    <script>
        let serverUrl = 'http://localhost:3000';
        let moments = [];
        let aiReplyCount = 0;

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        window.addEventListener('load', function() {
            checkServerStatus();
            refreshMoments();
        });

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServerStatus() {
            const statusIndicator = document.getElementById('serverStatus');
            const checkIcon = document.getElementById('checkStatusIcon');
            
            checkIcon.innerHTML = '<div class="loading"></div>';
            addLog('æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...', 'info');

            try {
                serverUrl = document.getElementById('serverUrl').value;
                const response = await fetch(`${serverUrl}/api/health`);
                const data = await response.json();

                if (response.ok) {
                    statusIndicator.className = 'status-indicator online';
                    addLog(`âœ… æœåŠ¡å™¨åœ¨çº¿ - AIæä¾›å•†: ${data.aiProvider}`, 'success');
                    addLog(`ğŸ“Š å½“å‰åŠ¨æ€æ•°é‡: ${data.momentsCount}`, 'info');
                    checkIcon.innerHTML = 'âœ…';
                } else {
                    throw new Error('æœåŠ¡å™¨å“åº”å¼‚å¸¸');
                }
            } catch (error) {
                statusIndicator.className = 'status-indicator error';
                addLog(`âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                checkIcon.innerHTML = 'âŒ';
            }
        }

        // å‘å¸ƒåŠ¨æ€
        async function publishMoment() {
            const publishBtn = document.getElementById('publishBtn');
            const username = document.getElementById('username').value;
            const content = document.getElementById('momentContent').value;

            if (!content.trim()) {
                addLog('âŒ åŠ¨æ€å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            publishBtn.disabled = true;
            publishBtn.innerHTML = '<div class="loading"></div> å‘å¸ƒä¸­...';

            try {
                addLog(`ğŸ“¤ æ­£åœ¨å‘å¸ƒåŠ¨æ€: "${content.substring(0, 20)}..."`, 'info');

                const response = await fetch(`${serverUrl}/api/moments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: 'user',
                        username: username,
                        content: content
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addLog(`âœ… åŠ¨æ€å‘å¸ƒæˆåŠŸ - ID: ${data.data.id}`, 'success');
                    addLog('â° ç­‰å¾… AI äº’åŠ¨è§¦å‘ (70% æ¦‚ç‡, 10-30ç§’å»¶è¿Ÿ)', 'info');
                    
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('momentContent').value = '';
                    
                    // åˆ·æ–°åŠ¨æ€åˆ—è¡¨
                    setTimeout(() => {
                        refreshMoments();
                    }, 1000);

                    // 30ç§’åå†æ¬¡åˆ·æ–°ï¼Œæ£€æŸ¥AIå›å¤
                    setTimeout(() => {
                        refreshMoments();
                        addLog('ğŸ”„ è‡ªåŠ¨åˆ·æ–°åŠ¨æ€åˆ—è¡¨ï¼Œæ£€æŸ¥ AI äº’åŠ¨', 'info');
                    }, 30000);

                } else {
                    throw new Error(data.message || 'å‘å¸ƒå¤±è´¥');
                }
            } catch (error) {
                addLog(`âŒ å‘å¸ƒåŠ¨æ€å¤±è´¥: ${error.message}`, 'error');
            } finally {
                publishBtn.disabled = false;
                publishBtn.innerHTML = '<span>ğŸ“¤</span> å‘å¸ƒåŠ¨æ€';
            }
        }

        // åˆ·æ–°åŠ¨æ€åˆ—è¡¨
        async function refreshMoments() {
            try {
                addLog('ğŸ”„ æ­£åœ¨åˆ·æ–°åŠ¨æ€åˆ—è¡¨...', 'info');

                const response = await fetch(`${serverUrl}/api/moments`);
                const data = await response.json();

                if (response.ok) {
                    moments = data.data || [];
                    updateMomentsList();
                    updateMomentsSelect();
                    updateStats();
                    addLog(`âœ… åŠ¨æ€åˆ—è¡¨å·²åˆ·æ–° - å…± ${moments.length} æ¡åŠ¨æ€`, 'success');
                } else {
                    throw new Error(data.message || 'è·å–åŠ¨æ€å¤±è´¥');
                }
            } catch (error) {
                addLog(`âŒ åˆ·æ–°åŠ¨æ€åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ›´æ–°åŠ¨æ€åˆ—è¡¨æ˜¾ç¤º
        function updateMomentsList() {
            const momentsList = document.getElementById('momentsList');
            
            if (moments.length === 0) {
                momentsList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">æš‚æ— åŠ¨æ€ï¼Œè¯·å…ˆå‘å¸ƒä¸€æ¡åŠ¨æ€</div>';
                return;
            }

            momentsList.innerHTML = moments.map(moment => {
                const commentsHtml = moment.comments.map((comment, index) => {
                    const isAI = comment.userId.startsWith('ai_');
                    return `
                        <div class="comment-item ${isAI ? 'ai-comment' : ''}">
                            <strong>${comment.username}:</strong> ${comment.content}
                            ${isAI ? ' ğŸ¤–' : ''}
                        </div>
                    `;
                }).join('');

                return `
                    <div class="moment-item">
                        <div class="moment-header">
                            <div class="moment-avatar">${moment.username.charAt(0)}</div>
                            <div>
                                <strong>${moment.username}</strong>
                                <div style="font-size: 0.8em; color: #6c757d;">
                                    ID: ${moment.id} | ${new Date(moment.timestamp).toLocaleString()}
                                </div>
                            </div>
                        </div>
                        <div class="moment-content">${moment.content}</div>
                        <div class="moment-actions">
                            <span>ğŸ‘ ${moment.likes.length}</span>
                            <span>ğŸ’¬ ${moment.comments.length}</span>
                        </div>
                        ${moment.comments.length > 0 ? `
                            <div class="comments-list">
                                ${commentsHtml}
                            </div>
                        ` : ''}
                        <div class="comment-input">
                            <input type="text" class="form-control" placeholder="å†™è¯„è®º..." id="comment_${moment.id}">
                            <button class="btn btn-primary" onclick="addComment(${moment.id})">å‘é€</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°åŠ¨æ€é€‰æ‹©ä¸‹æ‹‰æ¡†
        function updateMomentsSelect() {
            const select = document.getElementById('momentSelect');
            
            if (moments.length === 0) {
                select.innerHTML = '<option value="">è¯·å…ˆå‘å¸ƒåŠ¨æ€</option>';
                return;
            }

            select.innerHTML = moments.map(moment => 
                `<option value="${moment.id}">ID: ${moment.id} - ${moment.content.substring(0, 30)}...</option>`
            ).join('');
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('totalMoments').textContent = moments.length;
            
            // è®¡ç®—AIå›å¤æ•°é‡
            aiReplyCount = 0;
            moments.forEach(moment => {
                moment.comments.forEach(comment => {
                    if (comment.userId.startsWith('ai_')) {
                        aiReplyCount++;
                    }
                });
            });
            document.getElementById('aiReplies').textContent = aiReplyCount;
        }

        // æ·»åŠ è¯„è®º
        async function addComment(momentId) {
            const commentInput = document.getElementById(`comment_${momentId}`);
            const content = commentInput.value.trim();

            if (!content) {
                addLog('âŒ è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            try {
                addLog(`ğŸ’¬ æ­£åœ¨æ·»åŠ è¯„è®ºåˆ°åŠ¨æ€ ${momentId}: "${content}"`, 'info');

                const response = await fetch(`${serverUrl}/api/moments/${momentId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: 'user',
                        username: 'æµ‹è¯•ç”¨æˆ·',
                        content: content
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addLog(`âœ… è¯„è®ºæ·»åŠ æˆåŠŸ`, 'success');
                    addLog('â° ç­‰å¾… AI å›å¤ (70% æ¦‚ç‡, 3-8ç§’å»¶è¿Ÿ)', 'info');
                    
                    commentInput.value = '';
                    
                    // å»¶è¿Ÿåˆ·æ–°ï¼Œç­‰å¾…AIå›å¤
                    setTimeout(() => {
                        refreshMoments();
                        addLog('ğŸ”„ è‡ªåŠ¨åˆ·æ–°åŠ¨æ€åˆ—è¡¨ï¼Œæ£€æŸ¥ AI å›å¤', 'info');
                    }, 10000);

                } else {
                    throw new Error(data.message || 'è¯„è®ºå¤±è´¥');
                }
            } catch (error) {
                addLog(`âŒ æ·»åŠ è¯„è®ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•AIå›å¤
        async function testAIReply() {
            const momentId = document.getElementById('momentSelect').value;
            const testComment = document.getElementById('testComment').value.trim();
            const testBtn = document.getElementById('testAIBtn');

            if (!momentId) {
                addLog('âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåŠ¨æ€', 'error');
                return;
            }

            if (!testComment) {
                addLog('âŒ è¯·è¾“å…¥æµ‹è¯•è¯„è®ºå†…å®¹', 'error');
                return;
            }

            testBtn.disabled = true;
            testBtn.innerHTML = '<div class="loading"></div> æµ‹è¯•ä¸­...';

            try {
                addLog(`ğŸ¯ å¼€å§‹æµ‹è¯• AI å›å¤ - åŠ¨æ€ID: ${momentId}`, 'info');
                addLog(`ğŸ“ æµ‹è¯•è¯„è®º: "${testComment}"`, 'info');

                const response = await fetch(`${serverUrl}/api/moments/${momentId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: 'user',
                        username: 'æµ‹è¯•ç”¨æˆ·',
                        content: testComment
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addLog(`âœ… æµ‹è¯•è¯„è®ºå‘é€æˆåŠŸ`, 'success');
                    addLog('â° æ­£åœ¨ç­‰å¾… AI å›å¤...', 'warning');
                    
                    // æ¸…ç©ºæµ‹è¯•è¯„è®ºè¾“å…¥æ¡†
                    document.getElementById('testComment').value = '';
                    
                    // å¼€å§‹è½®è¯¢æ£€æŸ¥AIå›å¤
                    let checkCount = 0;
                    const maxChecks = 12; // æœ€å¤šæ£€æŸ¥12æ¬¡ (60ç§’)
                    
                    const checkInterval = setInterval(async () => {
                        checkCount++;
                        addLog(`ğŸ” æ£€æŸ¥ AI å›å¤... (${checkCount}/${maxChecks})`, 'info');
                        
                        await refreshMoments();
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„AIå›å¤
                        const moment = moments.find(m => m.id == momentId);
                        if (moment) {
                            const aiComments = moment.comments.filter(c => c.userId.startsWith('ai_'));
                            const latestAIComment = aiComments[aiComments.length - 1];
                            
                            if (latestAIComment && new Date(latestAIComment.timestamp) > new Date(Date.now() - 60000)) {
                                addLog(`ğŸ‰ AI å›å¤æˆåŠŸ: "${latestAIComment.content}"`, 'success');
                                addLog(`ğŸ¤– AI è§’è‰²: ${latestAIComment.username}`, 'success');
                                clearInterval(checkInterval);
                                return;
                            }
                        }
                        
                        if (checkCount >= maxChecks) {
                            addLog(`â° AI å›å¤æ£€æŸ¥è¶…æ—¶ (å¯èƒ½æœªè§¦å‘æˆ–å»¶è¿Ÿè¾ƒé•¿)`, 'warning');
                            addLog(`ğŸ’¡ æç¤º: AI å›å¤æœ‰70%æ¦‚ç‡è§¦å‘ï¼Œè¯·æŸ¥çœ‹åç«¯æ—¥å¿—ç¡®è®¤`, 'info');
                            clearInterval(checkInterval);
                        }
                    }, 5000);

                } else {
                    throw new Error(data.message || 'æµ‹è¯•å¤±è´¥');
                }
            } catch (error) {
                addLog(`âŒ AI å›å¤æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = '<span>ğŸ¯</span> æµ‹è¯• AI å›å¤';
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '<div class="log-entry info"><span class="timestamp">[æ¸…ç©º]</span> æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
        setInterval(() => {
            refreshMoments();
        }, 30000); // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
    </script>
</body>
</html>